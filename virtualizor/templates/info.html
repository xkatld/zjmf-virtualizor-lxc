<style>
/* 简洁专业设计风格 */

.resource-card {
    border: 1px solid #e1e5e9;
    border-radius: 6px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s ease;
}

.resource-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.resource-header {
    color: #495057;
    font-weight: 600;
    font-size: 0.8rem;
    margin-bottom: 6px;
}

.resource-header i {
    color: #6c757d;
    margin-right: 4px;
    font-size: 0.85rem;
}

/* 响应式设计 */
@media (max-width: 1200px) {
    .resource-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .resource-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .resource-grid-item {
        padding: 12px;
    }
    
    .resource-value {
        font-size: 1.1rem;
        margin-bottom: 8px;
    }
    
    .resource-header {
        font-size: 0.75rem;
    }
}

.resource-value.text-primary {
    color: #007bff !important;
}

.resource-value.text-success {
    color: #28a745 !important;
}

.resource-value.text-info {
    color: #17a2b8 !important;
}

.resource-value.text-warning {
    color: #ffc107 !important;
}

.resource-icon {
    opacity: 0.15;
    color: #6c757d;
    font-size: 1.5rem !important;
}

.badge {
    font-size: 0.8rem;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 4px;
}

.badge-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.badge-secondary {
    background: #6c757d;
    color: white;
}

.badge-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

/* 一排4个卡片 - 更紧凑的布局 */
.resource-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    min-height: auto;
}

.resource-grid-item {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 12px;
    height: 100%;
}

.resource-value {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 6px;
    min-height: 1.4rem;
    display: flex;
    align-items: center;
}

/* Chart.js 图表样式 */
canvas {
    width: 100% !important;
    height: 150px !important;
}
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 等待 Chart.js 加载
window.chartJsLoaded = false;
if (typeof Chart !== 'undefined') {
    window.chartJsLoaded = true;
} else {
    // 轮询检查 Chart.js 是否加载
    const checkChart = setInterval(() => {
        if (typeof Chart !== 'undefined') {
            window.chartJsLoaded = true;
            clearInterval(checkChart);
        }
    }, 50);
}
</script>

<div class="container-fluid">
<div class="card shadow mb-2">
    <div class="card-header d-flex justify-content-between align-items-center py-3">
        <div>
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-tachometer-alt mr-2"></i>容器状态监控
            </h6>
            <small class="text-muted">实时显示容器资源使用情况</small>
            <span class="badge badge-info mt-1">
                最后更新: <span id="last-update">刚刚</span>
            </span>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="refreshInfoPage()">
            <i class="fas fa-sync-alt mr-1"></i>刷新
        </button>
    </div>
    <div class="card-body">
        <div class="resource-grid">
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-microchip"></i>CPU使用率
                        </div>
                        <div class="resource-value text-primary" id="cpu-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-microchip resource-icon"></i>
                </div>
                <canvas id="cpuChart"></canvas>
            </div>
            
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-memory"></i>内存使用
                        </div>
                        <div class="resource-value text-success" id="memory-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-memory resource-icon"></i>
                </div>
                <canvas id="memoryChart"></canvas>
            </div>
            
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-hdd"></i>硬盘使用
                        </div>
                        <div class="resource-value text-info" id="disk-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-hdd resource-icon"></i>
                </div>
                <canvas id="diskChart"></canvas>
            </div>
            
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-exchange-alt"></i>流量使用
                        </div>
                        <div class="resource-value text-warning" id="traffic-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-exchange-alt resource-icon"></i>
                </div>
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-question-circle mr-2"></i>使用说明
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-key text-success mr-2"></i><strong>初始密码:</strong> 已在开通时设置</li>
                    <li class="mb-2"><i class="fas fa-clock text-warning mr-2"></i><strong>自动刷新:</strong> 图表每10秒更新</li>
                    <li class="mb-2"><i class="fas fa-chart-line text-primary mr-2"></i><strong>数据趋势:</strong> 显示最近20次数据</li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-cog text-secondary mr-2"></i>可通过操作按钮管理容器</li>
                    <li class="mb-2"><i class="fas fa-mouse-pointer text-info mr-2"></i>点击刷新按钮手动更新</li>
                    <li class="mb-2"><i class="fas fa-chart-bar text-danger mr-2"></i>资源超过90%时请注意</li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// 使用命名空间避免全局变量冲突
window.VirtualizorMonitor = window.VirtualizorMonitor || {};
(function(VM) {
    VM.currentInfoContainerId = '';
    VM.cpuChart = null;
    VM.memoryChart = null;
    VM.diskChart = null;
    VM.trafficChart = null;

// 初始化 Chart.js 图表
VM.initCharts = function() {
    const chartConfig = {
        type: 'line',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: '#f0f0f0' },
                    ticks: { 
                        color: '#999', 
                        font: { size: 9 },
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            elements: {
                line: { tension: 0.4, borderWidth: 2 },
                point: { radius: 0, hitRadius: 10, hoverRadius: 3 }
            }
        }
    };

    const maxDataPoints = 20;
    const labels = Array(maxDataPoints).fill('');

    VM.cpuChart = new Chart(document.getElementById('cpuChart'), {
        ...chartConfig,
        data: {
            labels: labels,
            datasets: [{ data: Array(maxDataPoints).fill(0), borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)', fill: true }]
        }
    });

    VM.memoryChart = new Chart(document.getElementById('memoryChart'), {
        ...chartConfig,
        data: {
            labels: labels,
            datasets: [{ data: Array(maxDataPoints).fill(0), borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', fill: true }]
        }
    });

    VM.diskChart = new Chart(document.getElementById('diskChart'), {
        ...chartConfig,
        data: {
            labels: labels,
            datasets: [{ data: Array(maxDataPoints).fill(0), borderColor: '#17a2b8', backgroundColor: 'rgba(23, 162, 184, 0.1)', fill: true }]
        }
    });

    VM.trafficChart = new Chart(document.getElementById('trafficChart'), {
        ...chartConfig,
        data: {
            labels: labels,
            datasets: [{ data: Array(maxDataPoints).fill(0), borderColor: '#ffc107', backgroundColor: 'rgba(255, 193, 7, 0.1)', fill: true }]
        }
    });
};

VM.updateChart = function(chart, value) {
    if (!chart) return;
    const data = chart.data.datasets[0].data;
    data.shift();
    data.push(value);
    chart.update('none');
};

VM.refreshInfoPage = function() {
    VM.updateLastUpdateTime();
    VM.loadContainerInfo();
};

window.refreshInfoPage = VM.refreshInfoPage;

VM.updateLastUpdateTime = function() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    const lastUpdateElement = document.getElementById('last-update');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = timeString;
    }
};

VM.loadContainerInfo = function() {
    if (!VM.currentInfoContainerId) {
        const urlParams = new URLSearchParams(window.location.search);
        const containerId = urlParams.get('id');

        if (!containerId) {
            VM.showError('无法获取容器ID');
            return;
        }
        VM.currentInfoContainerId = containerId;
    }

    if (typeof jQuery !== 'undefined') {
        jQuery('#last-update').html('<i class="fas fa-spinner fa-spin"></i> 更新中...');
    }
    VM.loadAllInfoData(VM.currentInfoContainerId);
};

VM.loadAllInfoData = function(containerId) {
    const timestamp = new Date().getTime();
    const infoUrl = `/provision/custom/content?id=${containerId}&key=info&action=getinfoall&_t=${timestamp}`;

    if (typeof jQuery !== 'undefined') {
        jQuery.ajax({
            url: infoUrl,
            method: 'GET',
            dataType: 'json',
            timeout: 10000,
            cache: false,
            success: function(response) {
                if (response && response.code === 200 && response.data) {
                    VM.updateAllInfo(response.data);
                } else {
                    VM.showError(response.msg || '获取容器信息失败');
                }
            },
            error: function(xhr, status, error) {
                VM.showError('网络请求失败: ' + error);
            }
        });
    }
};

VM.updateAllInfo = function(data) {
    if (typeof jQuery === 'undefined') return;
    const $ = jQuery;
    
    // CPU - 显示格式: xx% / x核
    const cpuUsage = parseFloat(data.cpu_usage || data.used_cpu || data.cpu_percent || 0);
    const cpuCores = data.cpu_cores || data.cpus || data.cores || 1;
    $('#cpu-info').text(cpuUsage.toFixed(2) + '% / ' + cpuCores + '核');
    VM.updateChart(VM.cpuChart, cpuUsage);

    // 内存 - MB，图表显示百分比
    const memoryUsed = parseFloat(data.memory_used || data.used_ram || data.memory_usage_raw / (1024*1024) || 0);
    const memoryTotal = parseFloat(data.memory || data.ram || 1024);
    const memoryPercent = memoryTotal > 0 ? (memoryUsed / memoryTotal) * 100 : 0;
    $('#memory-info').text(memoryUsed.toFixed(0) + ' MB / ' + memoryTotal.toFixed(0) + ' MB');
    VM.updateChart(VM.memoryChart, memoryPercent);

    // 硬盘 - GB，图表显示百分比
    const diskUsed = parseFloat(data.disk_used || data.used_disk || data.disk_usage_raw / (1024*1024*1024) || 0);
    const diskTotal = parseFloat(data.disk || 10);
    const diskPercent = diskTotal > 0 ? (diskUsed / diskTotal) * 100 : 0;
    $('#disk-info').text(diskUsed.toFixed(2) + ' GB / ' + diskTotal.toFixed(0) + ' GB');
    VM.updateChart(VM.diskChart, diskPercent);

    // 流量 - GB，图表显示百分比
    const trafficUsed = parseFloat(data.bandwidth_used || data.used_bandwidth || data.traffic_usage_raw / (1024*1024*1024) || 0);
    const trafficTotal = parseFloat(data.bandwidth || 0);
    const trafficPercent = trafficTotal > 0 ? (trafficUsed / trafficTotal) * 100 : 0;
    if (trafficTotal > 0) {
        $('#traffic-info').text(trafficUsed.toFixed(2) + ' GB / ' + trafficTotal.toFixed(0) + ' GB');
    } else {
        $('#traffic-info').text(trafficUsed.toFixed(2) + ' GB / 不限');
    }
    VM.updateChart(VM.trafficChart, trafficPercent);

    VM.updateLastUpdateTime();
};

VM.showError = function(message) {
    if (typeof jQuery === 'undefined') return;
    const $ = jQuery;
    
    $('#cpu-info').text('加载失败');
    $('#memory-info').text('加载失败');
    $('#disk-info').text('加载失败');
    $('#traffic-info').text('加载失败');

    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    $('#last-update').text(`${timeString} (错误)`);
};

})(window.VirtualizorMonitor);

// 初始化
(function() {
    var VM = window.VirtualizorMonitor;
    // 使用 IIFE 避免全局变量污染
    if (typeof jQuery === 'undefined') {
        console.error('jQuery 未加载');
        return;
    }
    
    jQuery(document).ready(function($) {
        // 等待 Chart.js 加载完成
        const waitForChart = setInterval(function() {
            if (window.chartJsLoaded || typeof Chart !== 'undefined') {
                clearInterval(waitForChart);
                
                // 初始化图表
                try {
                    VM.initCharts();
                } catch (e) {
                    console.error('图表初始化失败:', e);
                    return;
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const containerId = urlParams.get('id');

                if (!containerId) {
                    VM.showError('无法获取容器ID');
                    return;
                }

                VM.currentInfoContainerId = containerId;

                VM.updateLastUpdateTime();
                VM.loadContainerInfo();

                setInterval(function() {
                    VM.loadContainerInfo();
                }, 10000); // 每10秒刷新一次
            }
        }, 50);
        
        // 5秒超时保护
        setTimeout(function() {
            clearInterval(waitForChart);
            if (!VM.cpuChart) {
                console.error('Chart.js 加载超时，可能被网络防火墙拦截');
            }
        }, 5000);
    });
})();
</script>
